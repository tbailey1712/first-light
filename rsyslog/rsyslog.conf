# First Light — rsyslog Fan-Out Configuration
# Receives syslog from all network sources, routes to:
#   1. SigNoz OTel collector (TCP 5140)
#   2. Per-host log files for CrowdSec

# ─────────────────────────────────────────────────────────────
# MODULES
# ─────────────────────────────────────────────────────────────
# Note: omfile and omfwd are built-in to modern rsyslog, no need to load

module(load="imudp")
module(load="imtcp")

# ─────────────────────────────────────────────────────────────
# INPUT — Listen on UDP and TCP 514
# ─────────────────────────────────────────────────────────────

input(type="imudp" port="514")
input(type="imtcp" port="514")

# ─────────────────────────────────────────────────────────────
# TEMPLATES — Directory and file naming
# ─────────────────────────────────────────────────────────────

# Directory per host: /var/log/remote/{hostname}/
template(name="RemoteHostDir" type="string" string="/var/log/remote/%HOSTNAME%")

# Filename: syslog.log
template(name="RemoteHostFile" type="string" string="/var/log/remote/%HOSTNAME%/syslog.log")

# Format for CrowdSec (without priority prefix - breaks CrowdSec parser)
template(name="FileFormat" type="string" string="%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n")

# Format for SigNoz OTel collector (full RFC3164 with priority)
template(name="OtelFormat" type="string" string="<%PRI%>%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n")

# ─────────────────────────────────────────────────────────────
# OUTPUT 1 — Forward to SigNoz OTel Collector (TCP 5140)
# ─────────────────────────────────────────────────────────────

action(
    type="omfwd"
    target="signoz-otel-collector"
    port="5140"
    protocol="tcp"
    template="OtelFormat"
    queue.type="LinkedList"
    queue.size="10000"
    action.resumeRetryCount="-1"
)

# ─────────────────────────────────────────────────────────────
# OUTPUT 2 — Write to per-host log files for CrowdSec
# ─────────────────────────────────────────────────────────────

# Create directory if it doesn't exist
$DirCreateMode 0755
$FileCreateMode 0644

action(
    type="omfile"
    dynaFile="RemoteHostFile"
    dirCreateMode="0755"
    fileCreateMode="0644"
    template="FileFormat"
)
