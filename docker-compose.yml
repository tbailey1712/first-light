# First Light — Phase 1 MVP
# Network observability with CrowdSec threat intelligence + SigNoz unified observability

# Include SigNoz's official stack (ClickHouse, OTel collector, query service, frontend)
include:
  - signoz/docker-compose.yaml

services:
  # ── rsyslog — Fan-out router ─────────────────────────────────
  # Receives syslog on UDP/TCP 514, routes to:
  #   1. SigNoz OTel collector (TCP 5140)
  #   2. /var/log/remote/{host}/syslog.log files for CrowdSec
  rsyslog:
    image: rsyslog/syslog_appliance_alpine:latest
    container_name: fl-rsyslog
    restart: unless-stopped
    environment:
      - TZ=America/Chicago
    ports:
      - "514:514/udp"
      - "514:514/tcp"
    volumes:
      - ./rsyslog/rsyslog.conf:/etc/rsyslog.conf:ro
      - syslog_files:/var/log/remote
    networks:
      - signoz-net
    depends_on:
      - otel-collector

  # ── SNMP Exporter — Network device metrics ───────────────────
  # Polls switches, APs, etc. via SNMP for interface stats, bandwidth, errors
  # Exposes Prometheus metrics for OTel collector to scrape
  snmp-exporter:
    image: prom/snmp-exporter:v0.26.0
    container_name: fl-snmp-exporter
    restart: unless-stopped
    environment:
      - TZ=America/Chicago
    volumes:
      - ./snmp-exporter/snmp.yml:/etc/snmp_exporter/snmp.yml:ro
    ports:
      - "9116:9116"
    networks:
      - signoz-net

  # ── CrowdSec — Threat detection ──────────────────────────────
  # Tails log files written by rsyslog, runs community parsers/scenarios
  # Detection-only for MVP (no bouncers yet)
  crowdsec:
    image: crowdsecurity/crowdsec:v1.6.3
    container_name: fl-crowdsec
    restart: unless-stopped
    environment:
      - COLLECTIONS=crowdsecurity/pfsense crowdsecurity/linux crowdsecurity/sshd
      - ENROLL_KEY=${CROWDSEC_ENROLLMENT_KEY:-}
      - TZ=America/Chicago
    volumes:
      - crowdsec_data:/var/lib/crowdsec/data
      - crowdsec_config:/etc/crowdsec
      - ./crowdsec/acquis.yml:/etc/crowdsec/acquis.d/first-light.yml:ro
      - syslog_files:/var/log/remote:ro
    networks:
      - signoz-net

  # ── Webhook Relay — SigNoz to Telegram ───────────────────────
  # Receives Alertmanager-format webhooks from SigNoz
  # Translates and forwards alerts to Telegram bot
  webhook-relay:
    build: ./webhook-relay
    container_name: fl-webhook-relay
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TZ=America/Chicago
    ports:
      - "5000:5000"
    networks:
      - signoz-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  syslog_files:
    name: fl-syslog-files
  crowdsec_data:
    name: fl-crowdsec-data
  crowdsec_config:
    name: fl-crowdsec-config

# Note: signoz-net network is defined in signoz/docker-compose.yaml
